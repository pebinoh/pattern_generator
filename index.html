<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur de Pattern</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root {
            --primary: #333;
            --accent: #4a90e2; /* Couleur style lien/bouton */
            --bg: #ffffff;
            --gray-light: #f5f5f5;
            --border: #ddd;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            color: var(--primary);
            background: var(--bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Layout --- */
        .sidebar {
            width: 35%;
            padding: 40px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            background: #fdfdfd;
        }

        .main-app {
            width: 65%;
            display: flex;
            position: relative;
        }

        .viewer-3d {
            flex: 1;
            background: #fff;
            position: relative;
            cursor: grab;
        }

        .controls-panel {
            width: 300px;
            padding: 30px;
            background: #fff;
            border-left: 1px solid var(--border);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- Typography & Elements --- */
        h1 { font-size: 2.5rem; letter-spacing: -1px; margin-bottom: 10px; }
        h2 { font-size: 1.2rem; margin-top: 30px; margin-bottom: 10px; }
        p { line-height: 1.6; color: #555; font-size: 0.95rem; }
        strong { color: #000; }
        a { color: var(--primary); text-decoration: underline; cursor: pointer; }

        /* --- Form Elements --- */
        .control-group { margin-bottom: 15px; }
        .control-group label {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .input-row { display: flex; gap: 10px; }
        .input-wrapper { flex: 1; }
        
        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        input[type="range"] { width: 100%; cursor: pointer; }

        /* --- Tooltip (le petit 'i') --- */
        .info-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 16px;
            height: 16px;
            background: #eee;
            color: #666;
            border-radius: 50%;
            font-size: 10px;
            margin-left: 8px;
            cursor: help;
            position: relative;
            font-style: normal;
            font-weight: bold;
        }

        .info-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* --- Button --- */
        .btn-generate {
            background: linear-gradient(to bottom, #fff, #f9f9f9);
            border: 1px solid var(--border);
            padding: 15px;
            width: 100%;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            margin-top: auto;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .btn-generate:hover { background: #f0f0f0; border-color: #ccc; }

        /* --- Units Toggle --- */
        .units-toggle { display: flex; border: 1px solid var(--border); border-radius: 4px; width: fit-content; margin-bottom: 20px;}
        .unit-opt { padding: 5px 15px; font-size: 0.9rem; cursor: pointer; }
        .unit-opt.active { background: #eee; font-weight: 600; }

        /* --- MODAL (Génération) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }
        .modal h2 { margin-top: 0; }
        .close-modal {
            position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999;
        }
        canvas {
            border: 1px dashed #ddd;
            margin: 20px 0;
            max-width: 100%;
        }
        .btn-download {
            background: #333; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-size: 1rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-download:hover { background: #555; }

        /* Responsive */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow: auto; height: auto; }
            .sidebar, .main-app { width: 100%; }
            .main-app { flex-direction: column-reverse; height: 800px; }
            .controls-panel { width: 100%; border-left: none; border-top: 1px solid var(--border); }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>Générateur de pattern</h1>
        <p>
            Cet outil vous permet de créer un patron de couture simple pour une pochette/sac avec fermeture éclair sur le dessus.
            Personnalisez-le en ajoutant des onglets, poches, poignées ou étiquettes pour en faire votre propre création.
        </p>

        <h2>Comment ça marche ?</h2>
        <p>
            Configurer un projet avec ce générateur est simple et rapide. Visualisez le rendu en 3D à droite et ajustez les dimensions.
        </p>
        <p>
            L'aperçu en fil de fer (wireframe) vous montre la structure exacte. La ligne bleue représente la fermeture éclair.
        </p>

        <h2>C'est gratuit ?</h2>
        <p>
            C'est un projet passion. Si vous voulez soutenir le développement, partagez cet outil !
        </p>

        <h2>Avertissement</h2>
        <p style="font-size: 0.85rem; color: #777;">
            Ce logiciel est en version bêta, vérifiez toujours vos calculs avant de couper le tissu. Signalez les bugs si vous en trouvez.
        </p>
    </div>

    <div class="main-app">
        
        <div class="viewer-3d" id="scene-container">
            <div style="position: absolute; top: 20px; width: 100%; text-align: center; color: #999; pointer-events: none;">
                360° Aperçu <br> ↻
            </div>
            <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-family: monospace;" id="volume-display">
                Volume: 0.0L
            </div>
        </div>

        <div class="controls-panel">
            
            <div class="control-group">
                <label>Unités</label>
                <div class="units-toggle">
                    <div class="unit-opt">in</div>
                    <div class="unit-opt active">cm</div>
                </div>
            </div>

            <div class="control-group">
                <label>Construction <i class="info-icon" data-tooltip="Type de structure (1 pièce pliée ou 2 panneaux)">i</i></label>
                <select id="construction">
                    <option value="1">1 Panneau</option>
                    <option value="2">2 Panneaux</option>
                </select>
            </div>

            <div class="control-group">
                <label>Longueur</label>
                <div class="input-row">
                    <div class="input-wrapper">
                        <span style="font-size:0.8rem; color:#888;">Haut</span>
                        <input type="number" id="lenTop" value="20" step="0.5">
                    </div>
                    <div class="input-wrapper">
                        <span style="font-size:0.8rem; color:#888;">Bas</span>
                        <input type="number" id="lenBot" value="20" step="0.5">
                    </div>
                </div>
            </div>

            <div class="control-group">
                <label>Largeur (Profondeur) <i class="info-icon" data-tooltip="Épaisseur de la pochette">i</i></label>
                <input type="number" id="width" value="8" step="0.5">
            </div>

            <div class="control-group">
                <label>Hauteur <i class="info-icon" data-tooltip="Hauteur verticale finale">i</i></label>
                <input type="number" id="height" value="12" step="0.5">
            </div>

            <div class="control-group">
                <label>Marge de couture <i class="info-icon" data-tooltip="Espace ajouté pour la couture">i</i></label>
                <input type="number" id="seam" value="1" step="0.1">
            </div>

            <div class="control-group">
                <label>Largeur Zip <i class="info-icon" data-tooltip="Largeur totale de la bande zip">i</i></label>
                <input type="number" id="zipWidth" value="3" step="0.1">
            </div>

            <div class="control-group">
                <label>Descente Zip <i class="info-icon" data-tooltip="Jusqu'où descend la fermeture sur les côtés">i</i></label>
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; margin-bottom: 5px;">
                    <span>0%</span><span>100%</span>
                </div>
                <input type="range" id="zipReach" min="0" max="100" value="50">
            </div>

            <button class="btn-generate" onclick="openModal()">Générer le patron !</button>
        </div>
    </div>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2>Patron généré avec succès !</h2>
            
            <canvas id="patternCanvas" width="400" height="300"></canvas>
            
            <button class="btn-download" onclick="downloadPattern()">
                <span>⬇ Télécharger le patron (PNG)</span>
            </button>
            
            <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">
                Vérifiez toujours les cotes sur le tissu avant de couper.
            </p>
        </div>
    </div>

    <script>
        // --- THREE.JS SETUP ---
        const container = document.getElementById('scene-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff); // Fond blanc

        const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.set(30, 20, 30);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1.0;

        // Groupes pour les objets
        const bagGroup = new THREE.Group();
        scene.add(bagGroup);

        // Variables globales
        let inputs = {};

        function getInputs() {
            return {
                lTop: parseFloat(document.getElementById('lenTop').value) || 0,
                lBot: parseFloat(document.getElementById('lenBot').value) || 0,
                w: parseFloat(document.getElementById('width').value) || 0,
                h: parseFloat(document.getElementById('height').value) || 0,
                reach: parseInt(document.getElementById('zipReach').value) || 0
            };
        }

        // --- FONCTION DE DESSIN 3D ---
        function updateGeometry() {
            // Nettoyer l'ancien dessin
            while(bagGroup.children.length > 0){ 
                let obj = bagGroup.children[0];
                if(obj.geometry) obj.geometry.dispose();
                if(obj.material) obj.material.dispose();
                bagGroup.remove(obj); 
            }

            const { lTop, lBot, w, h, reach } = getInputs();
            const wHalf = w / 2;
            const hHalf = h / 2;

            // Définition des 8 coins de la boîte (Trapèze si Top != Bot)
            // Haut: y = +hHalf, Bas: y = -hHalf
            
            const v = {
                tfl: new THREE.Vector3(-lTop/2, hHalf, wHalf), // Top Front Left
                tfr: new THREE.Vector3(lTop/2, hHalf, wHalf),  // Top Front Right
                tbl: new THREE.Vector3(-lTop/2, hHalf, -wHalf),// Top Back Left
                tbr: new THREE.Vector3(lTop/2, hHalf, -wHalf), // Top Back Right
                bfl: new THREE.Vector3(-lBot/2, -hHalf, wHalf),// Bottom Front Left
                bfr: new THREE.Vector3(lBot/2, -hHalf, wHalf), // Bottom Front Right
                bbl: new THREE.Vector3(-lBot/2, -hHalf, -wHalf),// Bottom Back Left
                bbr: new THREE.Vector3(lBot/2, -hHalf, -wHalf) // Bottom Back Right
            };

            // Création des lignes de contour (Wireframe)
            const points = [
                v.tfl, v.tfr, v.tfr, v.tbr, v.tbr, v.tbl, v.tbl, v.tfl, // Top Loop
                v.bfl, v.bfr, v.bfr, v.bbr, v.bbr, v.bbl, v.bbl, v.bfl, // Bottom Loop
                v.tfl, v.bfl, v.tfr, v.bfr, v.tbr, v.bbr, v.tbl, v.bbl  // Vertical posts
            ];

            const geometry = new THREE.BufferGeometry().setFromPoints(points);
            const material = new THREE.LineBasicMaterial({ color: 0x333333 });
            const wireframe = new THREE.LineSegments(geometry, material);
            bagGroup.add(wireframe);

            // --- ZIPPER VISUALIZATION ---
            // Le zip est sur le dessus (Top Front & Top Back edges)
            // Et descend sur les côtés selon le "reach"
            
            // Calcul de la descente (interpolation linéaire entre Top et Bottom corners)
            const rRatio = reach / 100;
            
            // Points de descente (Gauche et Droite)
            const zipEndL = new THREE.Vector3().lerpVectors(v.tfl, v.bfl, rRatio); // Front Left Down
            const zipEndR = new THREE.Vector3().lerpVectors(v.tfr, v.bfr, rRatio); // Front Right Down
            // Pour simplifier l'affichage 3D, on montre le zip au milieu du top
            
            // On va dessiner une ligne bleue épaisse qui représente le zip
            const zipPoints = [];
            
            // Trajet Zip : Descend gauche -> Coin Haut Gauche -> Coin Haut Droit -> Descend Droit
            // Note: Simplification visuelle pour le wireframe
            
            // Coté gauche vertical
            zipPoints.push(new THREE.Vector3().lerpVectors(v.tbl, v.bbl, rRatio)); // Back Left Down
            zipPoints.push(v.tbl);
            // Traversée haut (centre ?) Non, généralement zip est au milieu de la largeur W
            // Faisons une ligne au milieu du top plane
            const midTL = new THREE.Vector3(-lTop/2, hHalf, 0);
            const midTR = new THREE.Vector3(lTop/2, hHalf, 0);
            const midDownL = new THREE.Vector3().lerpVectors(midTL, new THREE.Vector3(-lBot/2, -hHalf, 0), rRatio);
            const midDownR = new THREE.Vector3().lerpVectors(midTR, new THREE.Vector3(lBot/2, -hHalf, 0), rRatio);

            const zipGeo = new THREE.BufferGeometry().setFromPoints([midDownL, midTL, midTR, midDownR]);
            const zipMat = new THREE.LineBasicMaterial({ color: 0x4a90e2, linewidth: 3 });
            // Note: linewidth ne marche pas toujours sur WebGL Windows, donc on fait un TubeGeometry pour être sûr d'avoir de l'épaisseur si besoin, mais Line est plus simple/perf.
            const zipLine = new THREE.Line(zipGeo, zipMat);
            bagGroup.add(zipLine);

            // Affichage Volume (approx V = L*W*H / 1000 pour Litres)
            // Moyenne des aires haut et bas pour approximation trapèze
            const areaTop = lTop * w;
            const areaBot = lBot * w;
            const volCm3 = ((areaTop + areaBot)/2) * h;
            const volL = (volCm3 / 1000).toFixed(2);
            document.getElementById('volume-display').innerText = `Volume: ${volL}L`;
        }

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        updateGeometry();

        // Listeners sur les inputs
        document.querySelectorAll('input').forEach(el => {
            el.addEventListener('input', updateGeometry);
        });

        // Resize handler
        window.addEventListener('resize', () => {
            const width = container.clientWidth;
            const height = container.clientHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // --- MODAL & 2D PATTERN ---
        const modal = document.getElementById('modalOverlay');
        const cvs = document.getElementById('patternCanvas');
        const ctx = cvs.getContext('2d');

        function openModal() {
            modal.style.display = 'flex';
            drawPattern2D();
        }

        function closeModal() {
            modal.style.display = 'none';
        }

        // Fermer si on clique dehors
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        function drawPattern2D() {
            const { lTop, h, w, reach } = getInputs();
            const seam = parseFloat(document.getElementById('seam').value) || 0;
            
            // Reset canvas
            ctx.clearRect(0, 0, cvs.width, cvs.height);
            ctx.fillStyle = "#fff";
            ctx.fillRect(0,0, cvs.width, cvs.height);
            
            // Calculs simplifiés pour le dessin schématique (Forme en L vue de profil/panneau)
            // On dessine une représentation schématique comme sur la capture
            
            const scale = 20; // Scale factor pour affichage
            const padX = 50;
            const padY = 50;
            
            // Dimensions pour le dessin
            // Rectangle principal (Hauteur x Largeur/2 + marge ?)
            // Pour reproduire la capture, dessinons un L inversé qui représente:
            // Barre verticale : Hauteur + Fond/2
            // Barre horizontale : Longueur/2
            
            const drawH = (h + (w/2)) * scale;
            const drawL = (lTop/2) * scale;
            
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // Point de départ (Haut Gauche)
            let x = padX;
            let y = padY;
            
            // Forme en L (schématique d'un quart de patron)
            ctx.moveTo(x, y);
            ctx.lineTo(x + drawL, y); // Top
            ctx.lineTo(x + drawL, y + (h*scale)); // Coté interieur
            ctx.lineTo(x + drawL + (w/2*scale), y + (h*scale)); // Fond extension
            ctx.lineTo(x + drawL + (w/2*scale), y + drawH); // Bas
            ctx.lineTo(x, y + drawH); // Retour gauche
            ctx.closePath();
            ctx.stroke();

            // Remplissage léger
            ctx.fillStyle = "#f0f0f0";
            ctx.fill();

            // Annotations (Dimensions)
            ctx.fillStyle = "#000";
            ctx.font = "12px Inter";
            
            // Cote Haut
            ctx.fillText(`${(lTop/2 + seam).toFixed(1)} cm`, x + drawL/2, y - 10);
            
            // Cote Hauteur
            ctx.fillText(`${(h + seam).toFixed(1)} cm`, x - 35, y + (h*scale)/2);
            
            // Cote Fond
            ctx.fillText(`${(w/2 + seam).toFixed(1)}`, x + drawL + 5, y + drawH + 15);

            // Points de repère zip
            ctx.fillStyle = "blue";
            ctx.beginPath();
            ctx.arc(x + drawL, y + (h*scale * (reach/100)), 3, 0, 2*Math.PI);
            ctx.fill();
            ctx.fillText("Zip Stop", x + drawL + 5, y + (h*scale * (reach/100)));
        }

        function downloadPattern() {
            const link = document.createElement('a');
            link.download = 'patron-couture.png';
            link.href = cvs.toDataURL();
            link.click();
        }
    </script>
</body>
</html>
