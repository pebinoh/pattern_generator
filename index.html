<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zipworks Clone - Qualité HD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        :root { --bg: #ffffff; --ui-bg: #ffffff; --border: #eeeeee; }
        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; background: #fff; }

        /* --- Sidebar Gauche --- */
        .sidebar { width: 300px; padding: 40px; border-right: 1px solid var(--border); overflow-y: auto; }
        h1 { font-size: 2.5rem; margin: 0; font-weight: 800; letter-spacing: -1.5px; }
        .desc { font-size: 0.95rem; line-height: 1.5; color: #333; margin-top: 20px; }

        /* --- Zone Centrale (Le Rendu 3D) --- */
        .preview-container { flex-grow: 1; position: relative; background: #fff; display: flex; flex-direction: column; }
        #canvas-3d { width: 100%; height: 100%; outline: none; }
        .preview-label { position: absolute; top: 20px; width: 100%; text-align: center; font-style: italic; color: #888; font-size: 0.9rem; }
        .rotation-icon { position: absolute; top: 45px; left: 50%; transform: translateX(-50%); width: 30px; opacity: 0.6; }

        .bottom-ui { position: absolute; bottom: 40px; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .vol-display { font-size: 0.9rem; color: #555; }
        .btn-generate { background: #e0e0e0; border: none; padding: 12px 40px; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; }

        /* --- Sidebar Droite --- */
        .sidebar-right { width: 320px; padding: 30px; border-left: 1px solid var(--border); }
        .control-group { margin-bottom: 20px; position: relative; }
        label { display: flex; align-items: center; font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; box-sizing: border-box; }
        .row { display: flex; gap: 10px; }

        /* Tooltips */
        .info-i { background: #eee; border-radius: 50%; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; margin-left: 5px; cursor: help; position: relative; }
        .info-i:hover::after { content: attr(data-text); position: absolute; bottom: 25px; right: 0; background: #333; color: #fff; padding: 10px; border-radius: 5px; width: 180px; font-weight: normal; font-size: 12px; z-index: 100; }

        /* Fenêtre Modale HD */
        .modal-bg { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: #fff; border: 1px solid #eee; padding: 30px; border-radius: 8px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); width: 500px; }
        #pattern-preview { width: 100%; border: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1>zipworks</h1>
        <div class="desc">
            <strong>Pattern Generator</strong><br><br>
            Outil de création de patron pour pochette zippée.<br><br>
            <small>Logiciel en beta. Vérifiez vos calculs.</small>
        </div>
    </div>

    <div class="preview-container">
        <div class="preview-label">360° Preview</div>
        <svg class="rotation-icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm-6 8c0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3c-3.31 0-6-2.69-6-6z" fill="#888"/></svg>
        
        <canvas id="canvas-3d"></canvas>
        
        <div class="bottom-ui">
            <div class="vol-display" id="vol-text">Volume: 0.00L</div>
            <button class="btn-generate" onclick="generateHD()">Generate pattern!</button>
        </div>
    </div>

    <div class="sidebar sidebar-right">
        <div class="control-group"><label>Units: <strong>cm</strong></label></div>
        
        <div class="control-group">
            <label>Construction <span class="info-i" data-text="1 panneau: tissu plié au fond. 2 panneaux: couture au fond.">ⓘ</span></label>
            <select id="construction">
                <option value="1">1 Panel</option>
                <option value="2">2 Panels</option>
            </select>
        </div>

        <div class="control-group">
            <label>Length (Top / Bottom)</label>
            <div class="row">
                <input type="number" id="lenTop" value="20">
                <input type="number" id="lenBot" value="20">
            </div>
        </div>

        <div class="control-group">
            <label>Width</label>
            <input type="number" id="width" value="6">
        </div>

        <div class="control-group">
            <label>Height</label>
            <input type="number" id="height" value="12">
        </div>

        <div class="control-group">
            <label>Seam allowance <span class="info-i" data-text="Valeur de couture à ajouter tout autour (cm).">ⓘ</span></label>
            <input type="number" id="seam" value="1" step="0.1">
        </div>

        <div class="control-group">
            <label>Zipper width <span class="info-i" data-text="Largeur de la fermeture éclair sur le dessus.">ⓘ</span></label>
            <input type="number" id="zipW" value="2.5" step="0.1">
        </div>

        <div class="control-group">
            <label>Zipper reach <span class="info-i" data-text="Pourcentage de longueur occupé par le zip.">ⓘ</span></label>
            <input type="range" id="zipR" min="10" max="100" value="90">
        </div>
    </div>

    <div class="modal-bg" id="modal">
        <div class="modal">
            <h3>Pattern successfully generated!</h3>
            <canvas id="pattern-preview"></canvas>
            <a id="dl-link" style="display:block; background:#000; color:#fff; padding:15px; text-decoration:none; border-radius:4px; font-weight:bold;">Download full size PNG</a>
            <p style="font-size:11px; color:#888; margin-top:15px;">Le fichier est optimisé pour une impression nette.</p>
            <button onclick="document.getElementById('modal').style.display='none'" style="margin-top:10px; border:none; background:none; cursor:pointer; color:#888;">Close</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas-3d');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);

        const camera = new THREE.PerspectiveCamera(35, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
        camera.position.set(30, 20, 40);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        // --- FIX QUALITÉ 3D : Gestion du Pixel Ratio pour la netteté ---
        renderer.setPixelRatio(window.devicePixelRatio);
        
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;

        const group = new THREE.Group();
        scene.add(group);

        // Lumières pour un rendu propre
        scene.add(new THREE.AmbientLight(0xffffff, 0.9));
        const light = new THREE.DirectionalLight(0xffffff, 0.3);
        light.position.set(10, 20, 10);
        scene.add(light);

        function update3D() {
            while(group.children.length > 0) group.remove(group.children[0]);

            const L = parseFloat(document.getElementById('lenTop').value) || 10;
            const W = parseFloat(document.getElementById('width').value) || 5;
            const H = parseFloat(document.getElementById('height').value) || 10;
            const ZR = parseFloat(document.getElementById('zipR').value) / 100;
            const ZW = parseFloat(document.getElementById('zipW').value) || 0;

            // Création de la boîte (Mesh blanc propre)
            const geometry = new THREE.BoxGeometry(L, H, W);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.8,
                polygonOffset: true,
                polygonOffsetFactor: 1,
                polygonOffsetUnits: 1
            });
            const pouch = new THREE.Mesh(geometry, material);
            group.add(pouch);

            // --- FIX LIGNES : EdgesGeometry pour des traits noirs nets ---
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMat = new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 });
            const wireframe = new THREE.LineSegments(edges, lineMat);
            group.add(wireframe);

            // Visualisation de la fermeture (Fente sur le dessus)
            if (ZW > 0) {
                const zGeo = new THREE.PlaneGeometry(L * ZR, ZW);
                const zMat = new THREE.MeshBasicMaterial({ color: 0x000000, side: THREE.DoubleSide });
                const zip = new THREE.Mesh(zGeo, zMat);
                zip.rotation.x = Math.PI / 2;
                zip.position.y = H / 2 + 0.01;
                group.add(zip);
            }

            document.getElementById('vol-text').innerText = `Volume: ${(L*W*H/1000).toFixed(2)}L`;
        }

        // --- GÉNÉRATION PNG HD ---
        function generateHD() {
            const p = document.getElementById('pattern-preview');
            const ctx = p.getContext('2d');
            const L = parseFloat(document.getElementById('lenTop').value);
            const W = parseFloat(document.getElementById('width').value);
            const H = parseFloat(document.getElementById('height').value);
            const S = parseFloat(document.getElementById('seam').value);

            const totalW = L + W + (2*S);
            const totalH = H + (W/2) + (2*S);
            const PPCM = 80; // Résolution élevée

            p.width = totalW * PPCM;
            p.height = totalH * PPCM;

            ctx.fillStyle = "#fff"; ctx.fillRect(0,0,p.width,p.height);
            ctx.strokeStyle = "#000"; ctx.lineWidth = 5;

            const w = p.width; const h = p.height; const c = (W/2)*PPCM;
            ctx.beginPath();
            ctx.moveTo(0,0); ctx.lineTo(w,0); ctx.lineTo(w, h-c);
            ctx.lineTo(w-c, h-c); ctx.lineTo(w-c, h); ctx.lineTo(c, h);
            ctx.lineTo(c, h-c); ctx.lineTo(0, h-c); ctx.closePath(); ctx.stroke();

            document.getElementById('dl-link').href = p.toDataURL("image/png");
            document.getElementById('modal').style.display = "flex";
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            const w = canvas.clientWidth, h = canvas.clientHeight;
            if (canvas.width !== w || canvas.height !== h) {
                renderer.setSize(w, h, false);
                camera.aspect = w / h; camera.updateProjectionMatrix();
            }
            renderer.render(scene, camera);
        }

        document.querySelectorAll('input, select').forEach(i => i.addEventListener('input', update3D));
        update3D(); animate();
    </script>
</body>
</html>
